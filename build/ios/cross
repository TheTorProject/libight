#!/bin/sh
set -e

if [ $# -lt 1 ]; then
    echo "$0 i386|x86_64|armv7|armv7s|arm64 [command [args...]]" 1>&2
    exit 1
fi

ARCH=$1
shift

MINIOSVERSION="8.0"
if [ "$ARCH" = "armv7" -o "$ARCH" = "armv7s" -o "$ARCH" = "arm64" ]; then
    EXTRA_CONFIG="--host=arm-apple-darwin --target=arm-apple-darwin --disable-shared"
    MINVERSION="-miphoneos-version-min=$MINIOSVERSION"
    PLATFORM="iphoneos"
elif [ "$ARCH" = "i386" -o "$ARCH" = "x86_64" ]; then
    EXTRA_CONFIG="--host=${ARCH}-apple-darwin --target=${ARCH}-apple-darwin --disable-shared"
    MINVERSION="-mios-simulator-version-min=$MINIOSVERSION"
    PLATFORM="iphonesimulator"
else
    echo "$0: unsupported configuration" 1>&2
    exit 1
fi

echo ""
echo "Cross compiling for $PLATFORM and $ARCH"

ROOTDIR=$(cd $(dirname $0) && pwd -P)
SOURCEDIR="$ROOTDIR/../../"
DESTDIR="$ROOTDIR/tmp/${PLATFORM}/${ARCH}/"

export CC="$(xcrun -find -sdk ${PLATFORM} cc)"
export CXX="$(xcrun -find -sdk ${PLATFORM} g++)"
export CPPFLAGS="-arch ${ARCH} -isysroot $(xcrun -sdk ${PLATFORM} --show-sdk-path)"
export CFLAGS="-arch ${ARCH} $MINVERSION -isysroot $(xcrun -sdk ${PLATFORM} --show-sdk-path)"
export CXXFLAGS="-arch ${ARCH} $MINVERSION -isysroot $(xcrun -sdk ${PLATFORM} --show-sdk-path)"
export LDFLAGS="-arch ${ARCH} $MINVERSION -isysroot $(xcrun -sdk ${PLATFORM} --show-sdk-path)"

export pkg_configure_flags="$EXTRA_CONFIG"
export pkg_prefix="$DESTDIR"
export pkg_cross="ios"
export pkg_arch="$ARCH"

if [ $# -gt 0 ]; then
    $@
else
    env
fi

#!/bin/sh
set -e

if [ $# -lt 1 ]; then
    echo "usage: $0 spec-name [phase ...]" 1>&2
    exit 1
fi
spec_name=$1
shift

subr_start_over() {
    if [ -f Makefile ]; then
        make distclean
    fi
}

subr_autogen() {
    echo "- ./autogen.sh"
    ./autogen.sh
}

subr_configure() {
    echo "- ./configure $configure_flags"
    ./configure $configure_flags
}

subr_make() {
    echo "- make $make_flags V=0"
    make $make_flags V=0
}

subr_make_check() {
    if [ -z "$make_check_name" ]; then
        make_check_name=check
    fi
    echo "- make $make_flags $make_check_name V=0"
    if ! make $make_flags $make_check_name V=0; then
        if [ -f ./test-suite.log ]; then
            cat ./test-suite.log
        fi
        exit 1
    fi
}

subr_finalize() {
    exit 0
}

. build/docker/spec/$spec_name
env | sed 's/^COVERALLS_REPO_TOKEN=.*$/COVERALLS_REPO_TOKEN=[secure]/g'
sleep 5

if [ $# -eq 0 ]; then
    set -- depend start_over autogen configure make make_check finalize
fi

while [ $# -gt 0 ]; do
    echo ""
    echo "- - -"
    echo ""
    echo "# $1"
    echo ""
    subr_$1
    shift
done

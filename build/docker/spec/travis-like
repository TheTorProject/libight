#!/bin/sh
set -e

# Note: travis is a precise (i.e. 12.04) Ubuntu GNU/Linux

REPOROOT=$(cd $(dirname $(dirname $(dirname $(dirname $0)))) && pwd -P)

export CC=gcc-6 CPP="gcc-6 -E" CXX=g++-6

# We need these flags for the linker to work on travis
export LD_RUN_PATH=$REPOROOT/builtin LD_LIBRARY_PATH=$REPOROOT/builtin

# Note that we pass an empty CA bundle to test using our internal
# CA bundle that is the configuration we use on mobile devices
export configure_flags="$configure_flags --with-geoip=builtin --with-ca-bundle= --with-openssl=builtin --with-libevent=builtin"

debian_deps="$debian_deps autoconf"
debian_deps="$debian_deps automake"
debian_deps="$debian_deps git"
debian_deps="$debian_deps libtool"
debian_deps="$debian_deps make"
debian_deps="$debian_deps python-software-properties"
debian_deps="$debian_deps wget"

subr_depend() {
    apt-get update
    apt-get upgrade -y
    apt-get install -y $debian_deps
    apt-add-repository -y ppa:ubuntu-toolchain-r/test
    apt-get update
    apt-get install -y g++-6 gcc-6
}

subr_build_dependency() {
    if [ "$COVERAGE" = "--enable-coverage" ]; then
        pip install --user cpp-coveralls
    fi
    # Forward our build variables to the `./build/dependency` script
    export pkg_configure_flags="$configure_flags"
    export pkg_make_flags="$make_flags"
    #
    # On travis we build our own dependencies for two reasons:
    #
    # 1. because 12.04 has old libs that trigger many Valgrind warnings
    #
    # 2. because Valgrind is very old
    #
    ./build/dependency libressl
    ./build/dependency libevent
    ./build/dependency geoip
}

subr_finalize() {
    if [ "$COVERAGE" = "--enable-coverage" ]; then
        coveralls=$HOME/.local/bin/coveralls
        # Silence gcov standard output since it produces way too much output
        $coveralls --gcov /usr/bin/gcov-6 --exclude src/libmeasurement_kit/ext \
                  -b .  --exclude example --exclude third_party                \
                  --exclude include/measurement_kit/ext                        \
                  --exclude src/libmeasurement_kit/cmdline > /dev/null;
    fi
}

#!/bin/sh
set -e

ROOTDIR=$(cd $(dirname $0) && pwd -P)

if [ $# -lt 1 ]; then
    echo "Usage: $0 ARCH" 1>&2
    echo "" 1>&2
    echo "  ARCH: arm, arm64, mips, mips64, x86, x86_64" 1>&2
    echo "" 1>&2
    echo "Example usage:" 1>&2
    echo " $0 arm64" 1>&2
    exit 1
fi

ARCH=$1
shift 

echo ""
echo "Cross compiling for $ARCH"

export ANDROID_TOOLCHAIN=${ROOTDIR}/toolchain/${ARCH}
export SYSROOT=${ANDROID_TOOLCHAIN}/sysroot

if [ $ARCH = arm64 ]; then
    ARCH_FULLNAME=aarch64-linux-android
    export TOOL_PATH=${ANDROID_TOOLCHAIN}/bin/${ARCH_FULLNAME}
    DESTDIR_NAME=arm64-v8a
elif [ $ARCH = arm ]; then
    ARCH_FULLNAME=arm-linux-androideabi
    export TOOL_PATH=${ANDROID_TOOLCHAIN}/bin/${ARCH_FULLNAME}
    DESTDIR_NAME=armeabi
elif [ $ARCH = mips ]; then
    ARCH_FULLNAME=mipsel-linux-android
    export TOOL_PATH=${ANDROID_TOOLCHAIN}/bin/${ARCH_FULLNAME}
    DESTDIR_NAME=mips
elif [ $ARCH = mips64 ]; then
    ARCH_FULLNAME=mips64el-linux-android
    export TOOL_PATH=${ANDROID_TOOLCHAIN}/bin/${ARCH_FULLNAME}
    LIB_SUFFIX=64
    DESTDIR_NAME=mips64
    CONFIG_EXTRA="--disable-asm"
elif [ $ARCH = x86 ]; then
    ARCH_FULLNAME=i686-linux-android
    export TOOL_PATH=${ANDROID_TOOLCHAIN}/bin/${ARCH_FULLNAME}
    DESTDIR_NAME=x86
elif [ $ARCH = x86_64 ]; then
    ARCH_FULLNAME=x86_64-linux-android
    export TOOL_PATH=${ANDROID_TOOLCHAIN}/bin/${ARCH_FULLNAME}
    LIB_SUFFIX=64
    DESTDIR_NAME=x86_64
else
    echo "$0: invalid $ARCH" 1>&2
    exit 1
fi

export CPP=${TOOL_PATH}-cpp
export AR=${TOOL_PATH}-ar
export AS=${TOOL_PATH}-as
export NM=${TOOL_PATH}-nm
export CC=${TOOL_PATH}-clang
export CXX=${TOOL_PATH}-clang++
export LD=${TOOL_PATH}-ld
export RANLIB=${TOOL_PATH}-ranlib
export STRIP=${TOOL_PATH}-strip

export CPPFLAGS="${CPPFLAGS} --sysroot=${SYSROOT} -I${SYSROOT}/usr/include -I${ANDROID_TOOLCHAIN}/include"
export LDFLAGS="${LDFLAGS} -L${SYSROOT}/usr/lib${LIB_SUFFIX} -L${ANDROID_TOOLCHAIN}/lib"
export LIBS="-latomic -lm"

BUILDDIR="${ROOTDIR}/jni/${DESTDIR_NAME}"

export pkg_configure_flags="--host=${ARCH_FULLNAME} --disable-shared $CONFIG_EXTRA"
export pkg_prefix=${BUILDDIR}
export pkg_cross="android"

if [ $# -gt 0 ]; then
    $@
else
    env
fi

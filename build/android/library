#!/bin/sh
set -e
ROOTDIR=$(cd $(dirname $0) && pwd -P)

if [ $# -ne 0 ]; then
    echo "Usage: $0" 1>&2
fi

echo "Downloading and verifying precompiled dependencies from github"
(
    set -e # just in case
    cd $ROOTDIR
    DEPS_URL=https://github.com/measurement-kit/measurement-kit-deps/releases/download/2016-08-16/android-dependencies-20160816T182928Z.tgz
    DEPS_FILE=$(basename $DEPS_URL)
    curl --progress-bar -LO $DEPS_URL
    curl --progress-bar -LO $DEPS_URL.asc
    gpg2 --verify $DEPS_FILE.asc
    tar -xzf $DEPS_FILE
    rm $DEPS_FILE $DEPS_FILE.asc
)

echo "Building the library"
(
    set -e # just in case
    cd $ROOTDIR/../../
    . ./build/autogen.d/gen_sources
    . ./build/autogen.d/get_ext
    get_ext
    imk=./build/android/jni/include.mk
    echo "# Autogenerated by $0 on date $(date)"                      > $imk
    echo ""                                                          >> $imk
    gen_sources LOCAL_SRC_FILES src/libmeasurement_kit "../../../"   >> $imk
    cd ./build/android/jni
    ndk-build NDK_LIBS_OUT=./jniLibs $pkg_ndkbuild_flags
)

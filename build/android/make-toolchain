#!/bin/sh
set -e

if [ $# -ne 3 ]; then
    echo "Usage: $0 NDK_DIR ARCH API" 1>&2
    echo "  NDK_DIR: path where NDK is installed" 1>&2
    echo "  ARCH: aarch64-linux-android arm-linux-androideabi mipsel-linux-android mips64el-linux-android x86 x86_64" 1>&2
    echo "  API: 1 ... 21" 1>&2
    echo "Example usage (on MacOS using brew):" 1>&2
    echo "  $0 /usr/local/Cellar/android-ndk/r10e aarch64-linux-android 21" 1>&2
    exit 1
fi

ROOTDIR=$(cd $(dirname $0) && pwd -P)

NDK_DIR=$1
ARCH=$2
API=$3
BASEDIR=$ROOTDIR/toolchain

# XXX shortcut for armeabi-v7a
# According https://developer.android.com/ndk/guides/standalone_toolchain.html
# the proper solution is to override CFLAGS
if [ $ARCH = "arm-linux-androideabi-v7a" ]; then
    echo "WARNING: converting $ARCH to arm-linux-androideabi" 1>&2
    ARCH="arm-linux-androideabi"
fi

# Directory where to install the toolchain. This must be done _after_
# mapping the input architecture to a real toolchain architecture.
INSTALL_DIR=$BASEDIR/${ARCH}-${API}

MAKE_TOOLCHAIN=${NDK_DIR}/build/tools/make-standalone-toolchain.sh

echo "Creating toolchain for API ${API} and ARCH ${ARCH}-4.9 in ${INSTALL_DIR}"

# Bash is recommended to make the toolchain
bash $MAKE_TOOLCHAIN \
  --platform=android-${API} \
  --toolchain=${ARCH}-4.9 \
  --install-dir=${INSTALL_DIR} \
  --use-llvm \
  --stl=libc++ \
  --force

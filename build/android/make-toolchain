#!/bin/sh
set -e

if [ $# -ne 2 -a $# -ne 3 ]; then
    echo "" 1>&2
    echo "Usage: $0 NDK_DIR ARCH [API]" 1>&2
    echo "" 1>&2
    echo "  NDK_DIR: path where NDK is installed" 1>&2
    echo "  ARCH: arm, arm64, mips, mips64, x86, x86_64" 1>&2
    echo "  API: 1 ... 25" 1>&2
    echo "" 1>&2
    echo "If API is omitted, the minimum possible API for the " 1>&2
    echo "required architecture is used." 1>&2
    echo "" 1>&2
    echo "Example usage (on MacOS with Android Studio installed):" 1>&2
    echo "  $0 ~/Library/Android/sdk/ndk-bundle arm 19" 1>&2
    echo "" 1>&2
    exit 1
fi

ROOTDIR=$(cd $(dirname $0) && pwd -P)

NDK_DIR=$1
ARCH=$2
API=$3
BASEDIR=$ROOTDIR/toolchain

if [ "$API" = "" ]; then
    if [ "$ARCH" = "arm64" -o "$ARCH" = "mips64" -o "$ARCH" = "x86_64" ]; then
        API=21
    else
        API=14
    fi
fi

MAKE_TOOLCHAIN=${NDK_DIR}/build/tools/make_standalone_toolchain.py

INSTALL_DIR=$BASEDIR/${ARCH}
echo "Creating toolchain for API ${API} and ARCH ${ARCH} in ${INSTALL_DIR}"

$MAKE_TOOLCHAIN                                                                \
    --arch=${ARCH}                                                             \
    --api=${API}                                                               \
    --stl=libc++                                                               \
    --force                                                                    \
    --install-dir=${INSTALL_DIR}

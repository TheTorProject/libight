#!/bin/sh
set -e

pkg_topdir=$(cd $(dirname $0)/../../ && pwd -P)

[ "${pkg_os}" = "" ] && pkg_os=`uname -s | tr -s 'A-Z' 'a-z'`
[ "${pkg_arch}" = "" ] && pkg_arch=`uname -m`

pkg_name=measurement-kit

pkg_dist_dir=${pkg_topdir}/MK_DIST/${pkg_os}/${pkg_arch}
install -d ${pkg_dist_dir}

pkg_build_dir=${pkg_topdir}/MK_BUILD/${pkg_os}/${pkg_arch}/${pkg_name}
rm -rf ${pkg_build_dir}
mkdir -p ${pkg_build_dir}

(
    set -e

    cd ${pkg_topdir}

    if [ "$pkg_os" = "windows" ]; then
        autogen_sh_flags="--cmake"
    fi

    ./autogen.sh $autogen_sh_flags # Must run in the toplevel directory

    cd ${pkg_build_dir}

    if [ "$pkg_os" = "windows" ]; then
        dist_dir="..\\..\\..\\..\\MK_DIST"
        install_prefix="${dist_dir}\\${pkg_os}\\${pkg_arch}"
        libressl_prefix="${install_prefix}"
        libevent_prefix="${install_prefix}"
        geoip_prefix="${install_prefix}"
        cmake.exe -G "NMake Makefiles"                                         \
          -DCMAKE_WINDOWS_EXPORT_ALL_SYMBOLS=ON                                \
          -DCMAKE_INSTALL_PREFIX="${install_prefix}"                           \
          -DMK_CA_BUNDLE="\"\""                                                \
          -DMK_OPENSSL="${libressl_prefix}"                                    \
          -DMK_LIBEVENT="${libevent_prefix}"                                   \
          -DMK_GEOIP="${geoip_prefix}"                                         \
          -DMK_BUILD_EXAMPLES=OFF                                              \
          -DMK_BUILD_TESTS=OFF                                                 \
          -DMK_BUILD_INTEGRATION_TESTS=OFF                                     \
          "..\\..\\..\\..\\"
        nmake.exe /f Makefile install
	exit 0
    fi

    ../../../../configure --prefix=${pkg_dist_dir} --disable-shared           \
        --with-ca-bundle=certs.pem                                            \
        --disable-examples                                                    \
        --with-geoip=${pkg_dist_dir}                                          \
        --with-libevent=${pkg_dist_dir}                                       \
        --with-openssl=${pkg_dist_dir}                                        \
        ${pkg_configure_flags}

    make install

    # No `.la` files around because they will confuse other `./configure`.
    [ "${pkg_dist_dir}" != "" ] && rm -rf ${pkg_dist_dir}/lib/*.la
)

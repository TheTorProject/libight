#!/bin/sh

set -e

slug() {
    echo $(echo $1|tr '/-' '_'|sed 's/^include_measurement_kit/mk/g')
}

gen_headers() {
    echo "$(slug $1)_includedir = $1"
    echo "$(slug $1)_include_HEADERS = # Empty"
    for name in `ls $1`; do
        if [ ! -d $1/$name ]; then
            echo "$(slug $1)_include_HEADERS += $1/$name"
        fi
    done
    echo ""
    for name in `ls $1`; do
        if [ -d $1/$name ]; then
            gen_headers $1/$name
        fi
    done
}

gen_sources() {
    for name in `ls $2`; do
        if [ ! -d $2/$name ]; then
            if echo $name | grep -q '\.c[pp]*$'; then
                echo "$1 += $2/$name"
            fi
        fi
    done
    for name in `ls $2`; do
        if [ -d $2/$name ]; then
            gen_sources $1 $2/$name
        fi
    done
}

gen_executables() {
    for name in `ls $2`; do
        if [ ! -d $2/$name ]; then
            if echo $name | grep -q '\.c[pp]*$'; then
                bin_name=$(echo $name | sed 's/\.c[pp]*$//g')
                echo ""
                echo "if $3"
                echo "    $1 += $2/$bin_name"
                echo "endif"
                echo "$(slug $2/$bin_name)_SOURCES = $2/$name"
                echo "$(slug $2/$bin_name)_LDADD = libmeasurement_kit.la"
            fi
        fi
    done
    for name in `ls $2`; do
        if [ -d $2/$name ]; then
            gen_executables $1 $2/$name $3
        fi
    done
}

echo "* Generating Makefile-gen.am"

echo "# Autogenerated by $0 on date $(date)"            > Makefile-gen.am
echo ""                                                >> Makefile-gen.am
gen_headers include/measurement_kit                    >> Makefile-gen.am
gen_sources libmeasurement_kit_la_SOURCES src          >> Makefile-gen.am
gen_executables noinst_PROGRAMS example BUILD_EXAMPLES >> Makefile-gen.am
gen_executables ALL_TESTS test BUILD_TESTS             >> Makefile-gen.am

echo "* Running 'autoreconf -i'"
autoreconf -i
